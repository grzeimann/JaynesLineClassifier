# JaynesLineClassifier

A Jaynesian inference engine for labeling emission line sources by combining spectral data, deep photometry, and luminosity-function priors.

## Install (Conda only)

The recommended way to set up a working environment is with Conda using the conda-forge channel. Use the provided environment.yml to create the environment, then install this project into that environment.

1) Create and activate the Conda environment from environment.yml
- macOS/Linux/Windows (PowerShell or cmd):
  - conda env create -f environment.yml
  - conda activate jlc

2) Install JaynesLineClassifier into the active Conda environment
- From the repository root:
  - python -m pip install -e .

Notes
- We use pip only to install this repository into the already-activated Conda environment; all binary dependencies (numpy, pandas, astropy, scipy, matplotlib) come from conda-forge via environment.yml.
- To update an existing environment after changes to environment.yml:
  - conda env update -f environment.yml --prune
- Python 3.9+ is supported; 3.10 is pinned in the environment.yml for reproducibility.

## Quickstart
Given a CSV file with at least the columns: id, wave_obs, flux_hat, flux_err

- jlc classify path/to/input.csv --out path/to/output.csv

The output CSV will include, for each configured label (default: lae, oii, fake):
- logZ_<label>
- p_<label>

The p_<label> values per row should sum to approximately 1.

## Simulation mode
You can generate mock catalogs over a rectangular sky box and classify them with the built‑in labels (LAE, OII, Fake). Two modes are available:

1) Simple fraction-based simulator (original)
- Uniform sky within RA/DEC limits.
- User-provided class fractions control label ratios.
- Observed wavelengths are uniform within [wave_min, wave_max].
- Fluxes per class are drawn from simple placeholders.
- A hard selection is applied on measured flux (flux_hat > f_lim).

Example:
- jlc simulate --n 2000 --ra-low 150 --ra-high 160 --dec-low -2 --dec-high 2 \
  --wave-min 4800 --wave-max 9800 --f-lim 1e-17 --flux-err 5e-18 \
  --lae-frac 0.3 --oii-frac 0.3 --fake-frac 0.4 \
  --out-catalog sim_catalog.csv --out-classified sim_classified.csv \
  --plot-prefix sim

2) Model-driven PPP simulator (new)
- Uses a Poisson point process whose intensity is determined by the label models:
  - LAE/OII counts follow the luminosity function (Schechter) integrated over flux and the comoving volume element dV/dz within the wavelength band, scaled by the sky solid angle.
  - Selection is incorporated via the selection completeness S(F, λ_obs) when building the intensity.
  - Observed wavelengths are distributed according to the induced redshift prior (dV/dz × |dz/dλ|) for each label.
  - Fluxes are drawn from the LF transformed into flux-space at the sampled redshift.
  - Fakes are generated by a homogeneous PPP with a configurable rate per steradian per Angstrom.
- No additional hard selection is applied after measurement; selection is already encoded in the PPP intensity.

Example (PPP mode):
- jlc simulate --from-model --ra-low 150 --ra-high 160 --dec-low -2 --dec-high 2 \
  --wave-min 4800 --wave-max 9800 --f-lim 1e-17 --flux-err 5e-18 \
  --fake-rate 2e3 \
  --out-catalog sim_catalog.csv --out-classified sim_classified.csv \
  --plot-prefix sim

Key options for PPP mode:
- --from-model: enable PPP simulator.
- --fake-rate: fake rate density per steradian per Angstrom (default 0.0).
- --nz: number of redshift grid points used to construct the intensity (default 256).

Columns in the simulated catalog (both modes):
- ra, dec, true_class, wave_obs, flux_hat, flux_err

Notes:
- The selection model used during classification is configured with the same --f-lim value. In PPP mode, the selection also shapes the generated population via S(F, λ_obs).
- The PPP simulator relies on the default cosmology (Astropy Planck18) and the placeholder Schechter LF parameters configured in the CLI builder.
